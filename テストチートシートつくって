# Vue.js 保険商品シミュレーションページ テストコード詳細解説

## 📦 import文の解説

```javascript
// Vue.js のテストユーティリティをインポート
// mount: Vueコンポーネントを実際のDOMにマウントする関数
// createLocalVue: テスト用の独立したVueインスタンスを作成
import { mount, createLocalVue } from '@vue/test-utils'

// テスト対象のVueコンポーネントをインポート
import G01SimulationPage from '@/pages/G01SimulationPage.vue'

// 非同期処理（Promise）の完了を待つためのユーティリティ
import flushPromises from 'flush-promises'

// APIクライアント（axios）をインポート
import api from '@/services/api'

// axiosのHTTPリクエストをモック化するライブラリ
import MockAdapter from 'axios-mock-adapter'

// Vue Router（ページ遷移機能）をインポート
import Router from 'vue-router'

// Vuex（状態管理ライブラリ）をインポート
import Vuex from 'vuex';
```

## ⚙️ 初期設定の解説

```javascript
// MockAdapterのインスタンスを作成（APIリクエストをモック化）
const mockAxios = new MockAdapter(api)

// テスト用のローカルVueインスタンスを作成
const localVue = createLocalVue()

// ローカルVueにVue Routerプラグインを追加
localVue.use(Router)

// ローカルVueにVuexプラグインを追加
localVue.use(Vuex)

// Jestのタイムアウト時間を10秒に設定（非同期処理対応）
jest.setTimeout(10000);

// ブラウザのscrollTo関数をモック化（テスト環境では不要）
window.scrollTo = jest.fn()
```

## 🏗️ テストデータ作成関数の解説

```javascript
// 年齢計算APIのレスポンスデータを作成する関数
const getDateCalculate = () => {
  // 戻り値のテンプレートオブジェクトを定義
  const tmp = {
    result: true,           // API呼び出し成功フラグ
    transType: '1',        // トランザクションタイプ
    data: {
      calcBaseDate: '2019-10-01',  // 計算基準日
      fullAge: 20                   // 満年齢
    }
  }
  // オブジェクトのディープコピーを返す（元データの変更を防ぐ）
  return JSON.parse(JSON.stringify(tmp))
}
```

```javascript
// 保険料率データを作成する関数（非常に長いデータ）
const getInsurancerates = () => {
  const tmp = {
    result: true,     // API成功フラグ
    transType: '1',   // トランザクションタイプ
    data: [           // 保険商品データの配列
      {
        insuranceCd: "201",           // 保険商品コード
        amountFixedFlag: false,       // 金額固定フラグ
        unit: 1000,                   // 単位（1000円単位）
        benefitType: "1",             // 給付タイプ
        benefitRate: null,            // 給付率
        opeTypeCd: "3",              // 手術タイプコード
        opeRate: null,               // 手術率
        sixRate: null,               // 6大疾病率
        cancerTreatmentBenefits: null, // がん治療給付
        cancerDifferenceBed: null,    // がん差額ベッド
        gender: "2",                  // 性別（2=女性）
        age: 20,                      // 年齢
        amount60: 500,                // 60歳時の保険料
        amount65: 510,                // 65歳時の保険料
        amount70: 520,                // 70歳時の保険料
        amount75: 530,                // 75歳時の保険料
        amount80: 540,                // 80歳時の保険料
        amount85: 550,                // 85歳時の保険料
        amountLife: 560,              // 終身の保険料
        digitUnderDecimal: "3"        // 小数点以下桁数
      },
      // ... 他の保険商品データが続く
    ]
  }
  
  // 料率データを実際の値に変換する処理
  for (let index in tmp.data) {
    // 金額固定でない場合の処理
    if (!tmp.data[index].amountFixedFlag) {
      // 各年齢の保険料を単位で割って実際の料率を計算
      tmp.data[index].amount60 /= tmp.data[index].unit;
      tmp.data[index].amount70 /= tmp.data[index].unit;
      tmp.data[index].amount75 /= tmp.data[index].unit;
      tmp.data[index].amount80 /= tmp.data[index].unit;
      tmp.data[index].amount85 /= tmp.data[index].unit;
      tmp.data[index].amountLife /= tmp.data[index].unit;
      tmp.data[index].amount65 /= tmp.data[index].unit;
    }
  }
  // ディープコピーして返す
  return JSON.parse(JSON.stringify(tmp))
}
```

## 🎯 各テスト前の共通設定

```javascript
beforeEach(() => {
  // Vuexストアの初期化
  store = new Vuex.Store({
    modules: {                    // モジュール化されたストア
      agency: {                   // agency（代理店）モジュール
        namespaced: true,         // 名前空間を使用
        state: {                  // 状態
          agency: undefined       // 代理店情報（初期値は未定義）
        },
        actions: {                // アクション（非同期処理）
          getAgency: mockGetAgency, // 代理店情報取得（モック関数）
        },
        getters: {                // ゲッター（状態の取得）
          agency: state => state.agency, // 代理店情報を返す
        },
        mutations: {              // ミューテーション（状態の変更）
          // 代理店情報を設定
          set: (state, payload) => { 
            state.agency = payload.agency; 
          },
          // 代理店情報をクリア
          clear: state => { 
            state.agency = undefined; 
          },
        },
      },
    },
  })
  
  // モック関数が代理店情報を返すように設定
  // medical_rabbit_dealer_flag: 1 = メディカル兎取扱あり
  mockGetAgency.mockResolvedValueOnce({ medical_rabbit_dealer_flag: 1 });
});
```

## 🧪 実際のテストケースの解説

```javascript
// テストケースの説明
it('ケース 1-1 商品選択が表示されていること(商品表示コード000「商品選択なし」、20歳以上80歳以下、男性)', async () => {
  // テスト用の年齢を設定
  const setFullAge = 20;
  
  // 設定年齢から生年月日を計算
  const { setYear, setDate } = getDateToSet(setFullAge);

  // クッキー操作のモックオブジェクト
  const $cookies = {
    get: jest.fn(),    // クッキー取得関数のモック
    set: jest.fn()     // クッキー設定関数のモック
  }
  
  // 年齢計算APIのレスポンスデータを準備
  let dateCalculate = getDateCalculate()
  dateCalculate.data.calcBaseDate = setDate;  // 計算基準日を設定
  dateCalculate.data.fullAge = setFullAge;    // 満年齢を設定

  // モックAPIのレスポンスを設定
  // POST /date_calculate/ へのリクエストに対するレスポンス
  mockAxios.onPost('/date_calculate/').reply(200, dateCalculate)
  // POST /insurancerates/ へのリクエストに対するレスポンス
  mockAxios.onPost('/insurancerates/').reply(200, getInsurancerates())

  // Vueコンポーネントをマウント（実際のDOM要素として作成）
  wrapper = mount(G01SimulationPage, {
    localVue,                           // テスト用Vueインスタンス
    stubs: ['PageTopButton'],           // PageTopButtonコンポーネントをスタブ化
    mocks: { $cookies },               // モックオブジェクトを注入
    store,                             // Vuexストアを注入
    router: new Router()               // Vue Routerインスタンスを注入
  })
  
  // URLパラメータを設定（商品表示コード000）
  wrapper.vm.$router.push({ query: { parm4: '000' } })

  // ユーザーの入力操作をシミュレート
  wrapper.find('.birthDateYear').setValue(setYear)      // 生年を入力
  wrapper.find('.birthDateMonth').trigger('click')      // 月選択ボタンをクリック
  await wrapper.vm.$nextTick()                          // DOM更新を待機
  wrapper.find('#month_1').setChecked()                 // 1月を選択
  await wrapper.vm.$nextTick()                          // DOM更新を待機
  wrapper.find('.birthDateDay').trigger('click')        // 日選択ボタンをクリック
  await wrapper.vm.$nextTick()                          // DOM更新を待機
  wrapper.find('#date_1').setChecked()                  // 1日を選択
  await wrapper.vm.$nextTick()                          // DOM更新を待機
  
  // 性別選択（男性=1）
  const radioInput = wrapper
    .find('.gender')                    // 性別選択エリアを取得
    .find("input[value='1']")          // 男性（値=1）のラジオボタンを取得
  await wrapper.vm.$nextTick()         // DOM更新を待機
  await radioInput.setChecked()        // 男性を選択

  // シミュレーション実行ボタンをクリック
  wrapper.find('.simulationBtn').trigger('click')
  
  // 非同期処理（API呼び出し）の完了を待機
  await flushPromises()
  await wrapper.vm.$nextTick()         // DOM更新を待機

  // テスト結果の検証
  // メディカル礎女性専用以外の全商品が表示されている
  expect(wrapper.find("input[value='206']").isVisible()).toBe(true)   // メディカル礎: 表示
  expect(wrapper.find("input[value='999']").isVisible()).toBe(false)  // メディカル兎: 非表示（男性のため）
  expect(wrapper.find("input[value='147']").isVisible()).toBe(true)   // セブン: 表示
  expect(wrapper.find("input[value='153']").isVisible()).toBe(true)   // ワイド: 表示
  expect(wrapper.find("input[value='143']").isVisible()).toBe(true)   // がん一時金: 表示
  expect(wrapper.find("input[value='215']").isVisible()).toBe(true)   // がん治療極: 表示
  expect(wrapper.find("input[value='223']").isVisible()).toBe(true)   // なないろスリー: 表示
  
  // メディカル礎が選択されている
  expect(wrapper.find("input[value='206']").element.checked).toBe(true)   // メディカル礎: 選択済み
  expect(wrapper.find("input[value='999']").element.checked).toBe(false)  // メディカル兎: 未選択
  expect(wrapper.find("input[value='147']").element.checked).toBe(false)  // セブン: 未選択
  expect(wrapper.find("input[value='153']").element.checked).toBe(false)  // ワイド: 未選択
  expect(wrapper.find("input[value='143']").element.checked).toBe(false)  // がん一時金: 未選択
  expect(wrapper.find("input[value='215']").element.checked).toBe(false)  // がん治療極: 未選択
  expect(wrapper.find("input[value='223']").element.checked).toBe(false)  // なないろスリー: 未選択
  
  // テスト終了後のクリーンアップフラグを設定
  shouldResetParm4ToBlankor000 = true;
})
```

## 🧹 テスト後のクリーンアップ

```javascript
afterEach(() => {
  // 商品表示コード"000"の場合のクリーンアップ処理
  if (shouldResetParm4ToBlankor000) {
    // 商品表示コードなし"000"の場合は、param4=000で初期化する
    wrapper.vm.$router.push({ query: { parm4: '000' } });
    shouldResetParm4ToBlankor000 = false;  // フラグをリセット
  } else {
    // それ以外の場合は空文字で初期化
    wrapper.vm.$router.push({ query: { parm4: '' } });
  }
});
```

## 🔧 ヘルパー関数の解説

```javascript
// 設定する年齢の西暦を取得する関数
function getDateToSet(setAge) {
  // 現在の西暦を取得
  const currentYear = new Date().getFullYear();
  
  // 設定する年齢の西暦を計算（現在年 - 年齢）
  const setYear = String(currentYear - setAge)
  
  // 生年月日を 'YYYY-01-01' 形式で作成
  const setDate = setYear + '-01-01'
  
  // 西暦と日付の両方を返す
  return { setYear, setDate };
}
```

## 💡 重要なポイント

### 1. **非同期処理の扱い**
```javascript
await flushPromises()        // API呼び出し完了まで待機
await wrapper.vm.$nextTick() // DOM更新完了まで待機
```

### 2. **モックの活用**
```javascript
mockAxios.onPost('/date_calculate/').reply(200, dateCalculate) // APIレスポンスをモック化
mockGetAgency.mockResolvedValueOnce({...})                     // 関数の戻り値をモック化
```

### 3. **DOMの操作とテスト**
```javascript
wrapper.find('.birthDateYear').setValue(setYear)      // 入力値の設定
wrapper.find('#month_1').setChecked()                 // チェックボックスの選択
expect(wrapper.find("input[value='206']").isVisible()).toBe(true) // 表示状態の確認
```

このテストコードは、実際のユーザー操作をシミュレートして、ビジネスロジックが正しく動作するかを確認する非常に重要なテストです！
